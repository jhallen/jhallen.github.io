<h2>
The Verifone ZON Jr XL </h2>
Long ago I tried to start a business and wanted to accept credit card transactions, so I leased a credit card terminal from <a href="http://www.cardserviceinternational.com/">CardService International</a>.&nbsp; The business went nowhere, but I leased this machine long enough so that eventually I came to own it.&nbsp; I'm sure it cost me at least $1500 in lease payments.<br />
<br />
<div class="separator" style="clear: both; text-align: center;">
<a href="http://2.bp.blogspot.com/-5BwIYAcKges/UBs6yX3lUfI/AAAAAAAAAAM/pdZOrUGj4-w/s1600/DSCF1731.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="240" src="https://2.bp.blogspot.com/-5BwIYAcKges/UBs6yX3lUfI/AAAAAAAAAAM/pdZOrUGj4-w/s320/DSCF1731.JPG" width="320" /></a></div>
Now, many years later, I'm ready to get rid of it.&nbsp; I checked eBay: they sell for only $10- not even worth the effort to sell it.&nbsp; On the other hand, they are so cheap that they could have some value if they are easy to re-purpose through hacking.&nbsp; After all, they have a nice keypad and an alphanumeric vacuum fluorescent display.<br />
<br />
It also has an 8-pin DIN connector on the back, I think for a printer:<br />
<br />
<div class="separator" style="clear: both; text-align: center;">
<a href="http://1.bp.blogspot.com/-PLbI-jxxHPk/UBs9PLYw4zI/AAAAAAAAAAc/8pWN9ecXkbA/s1600/DSCF1732.JPG" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="240" src="https://1.bp.blogspot.com/-PLbI-jxxHPk/UBs9PLYw4zI/AAAAAAAAAAc/8pWN9ecXkbA/s320/DSCF1732.JPG" width="320" /></a></div>
<br />
<br />
I'd better take it apart before I dump it...<br />
<h2>
So what's inside of it?</h2>
Two screws on the back remove the back cover:<br />
<br />
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody>
<tr><td style="text-align: center;"><a href="http://1.bp.blogspot.com/-3AS3AueIS_8/UBs9qglXu7I/AAAAAAAAAAk/butAv95sXa4/s1600/DSCF1734.JPG" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="240" src="https://1.bp.blogspot.com/-3AS3AueIS_8/UBs9qglXu7I/AAAAAAAAAAk/butAv95sXa4/s320/DSCF1734.JPG" width="320" /></a></td></tr>
<tr><td class="tr-caption" style="text-align: center;">(click to enlarge)</td></tr>
</tbody></table>
<br />
<br />
<br />
<br />
<br />
The circuit board can then be pulled straight up (no screws).&nbsp; There is a 20-pin SIP connector connecting the main board to a keypad/display board:<br />
<br />
<br />
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody>
<tr><td style="text-align: center;"><a href="http://1.bp.blogspot.com/-Gdvb8yFMlOs/UBs-Rfv_XhI/AAAAAAAAAAs/yt0QmZUW6hk/s1600/DSCF1735.JPG" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="240" src="https://1.bp.blogspot.com/-Gdvb8yFMlOs/UBs-Rfv_XhI/AAAAAAAAAAs/yt0QmZUW6hk/s320/DSCF1735.JPG" width="320" /></a></td></tr>
<tr><td class="tr-caption" style="text-align: center;">(click to enlarge)</td></tr>
</tbody></table>
<br />
A close look at the main board and key/display board reveal 80's technology: all common through-hole chips:<br />
<br />
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody>
<tr><td style="text-align: center;"><a href="http://1.bp.blogspot.com/-I8Epc2V-hl8/UBs_ND8TuDI/AAAAAAAAAA0/HZdTMEUl0zI/s1600/DSCF1736.JPG" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="240" src="https://1.bp.blogspot.com/-I8Epc2V-hl8/UBs_ND8TuDI/AAAAAAAAAA0/HZdTMEUl0zI/s320/DSCF1736.JPG" width="320" /></a></td></tr>
<tr><td class="tr-caption" style="text-align: center;">(click to enlarge)</td></tr>
</tbody></table>
<br />
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody>
<tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-o08_mzTtdhM/UBs_OEWvHCI/AAAAAAAAAA8/oSvdhoAS_Kk/s1600/DSCF1737.JPG" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="240" src="https://3.bp.blogspot.com/-o08_mzTtdhM/UBs_OEWvHCI/AAAAAAAAAA8/oSvdhoAS_Kk/s320/DSCF1737.JPG" width="320" /></a></td></tr>
<tr><td class="tr-caption" style="text-align: center;">(click to enlarge)</td></tr>
</tbody></table>
<br />
Reverse engineering is going to be easy!<br />
<br />
<h2>
Parts List</h2>
So what do we have? The main board has these chips:<br />
<ul>
<li>7.15909 MHz crystal (twice the NTSC color burst frequency)</li>
<li>Y2, a 32768 Hz crystal</li>
<li>a 74HC04&nbsp;<a href="http://www.nxp.com/documents/data_sheet/74HC_HCT04.pdf">74HC04</a> hex inverter</li>
<li>an MC1489&nbsp;<a href="http://www.onsemi.com/pub/Collateral/MC1489-D.PDF">MC1489</a> RS-232 receiver</li>
<li>U1, an OKI <a href="http://www.alldatasheet.com/datasheet-pdf/pdf/11259/OKI/MSM6242B.html">M6242</a> real time clock</li>
<li>U2, a <a href="http://eshop.engineering.uiowa.edu/NI/pdfs/00/53/DS005348.pdf">74HC942</a> 300 baud modem</li>
<li>U3, a 74HC10&nbsp;<a href="http://www.nxp.com/documents/data_sheet/74HC_HCT10_CNV.pdf">74HC10</a> triple NAND gate</li>
<li>U4, a 27C256&nbsp;<a href="http://ww1.microchip.com/downloads/en/devicedoc/11001n.pdf">27C256</a> 32 KB EEPROM</li>
<li>U5 and U6: <a href="http://www.alldatasheet.com/datasheet-pdf/pdf/147630/MITSUBISHI/M5M5165P.html">M5M5165P</a> 8 KB static RAM chips</li>
<li>U7 <a href="http://gaby.de/z80/zip/z80cpu_um.pdf">Z80A</a> CPU</li>
<li>U9 <a href="http://www.alldatasheet.com/datasheet-pdf/pdf/50866/FAIRCHILD/CD4052.html">CD4052</a> dual 4-input analog MUX</li>
<li>U10 a <a href="http://elektronika-dasar.com/komponen/demultiplexer-3-ke-8-ic-74ls138/">74HC138</a> 3-bit decoder</li>
<li>U11 a <a href="http://gaby.de/z80/zip/z80ctc.pdf">Z80 CTC</a> (Counter Timer Circuit)</li>
<li>U12 and U15: <a href="http://www.nxp.com/documents/data_sheet/74HC_HCT259.pdf">74HC259</a>&nbsp; 8-bit addressable latch</li>
<li>U13 <a href="http://www.st.com/internet/com/TECHNICAL_RESOURCES/TECHNICAL_LITERATURE/DATASHEET/CD00000489.pdf">TL074CN</a> quad OP-Amp</li>
<li>U14 <a href="http://www.nxp.com/documents/data_sheet/74HC_HCT74.pdf">74HC74</a> dual flip-flop</li>
<li>U16 a <a href="http://gaby.de/z80/zip/z80piomn.pdf">Z80 PIO</a> (Parallel I/O controller)</li>
<li>U17 <a href="http://www.alldatasheet.com/datasheet-pdf/pdf/109258/UMC/UM95089.html">UM95089</a> touch-tone generator</li>
<li>L387A&nbsp;<a href="http://www.st.com/internet/com/TECHNICAL_RESOURCES/TECHNICAL_LITERATURE/DATASHEET/CD00010653.pdf">L387A</a> 5V regulator with reset generator</li>
<li><a href="http://www.soemtron.org/downloads/disposals/79l05.pdf">79L05</a> -5V regulator</li>
<li>Q1, Q2 and Q3: <a href="http://www.fairchildsemi.com/ds/2N/2N3904.pdf">2N3904</a> NPN transistors</li>
<li>A battery (dead) </li>
</ul>
The keypad / display board has these chips:<br />
<ul>
<li>U3, a <a href="http://pdf1.alldatasheet.com/datasheet-pdf/view/74524/MICREL/MIC10937P-40.html">10937P-40</a> Vacuum fluorescent driver</li>
<li>U2 a <a href="http://www.st.com/internet/com/TECHNICAL_RESOURCES/TECHNICAL_LITERATURE/DATASHEET/CD00000489.pdf">TL074CN</a> quad OP-Amp</li>
<li>A piezo speaker</li>
<li>High voltage generator circuit for the vacuum fluorescent display (it's got to have one, plus the round inductor near the top is a dead give-away).</li>
</ul>
Cool! It's a classic Z-80 system and the datasheet for every chip is available on the web.&nbsp; This is an easily hackable device.<br />
<br />
<h2>
&nbsp;Memory Map</h2>
An hour poking around with a continuity checker reveals the memory map.&nbsp; The 74HC10 and 74HC04 are used to make a simple address decoder for the memory space:<br />
<ul>
<li>U4 27C256 EPROM: 0x0000 - 0x7FFF (32 KB)</li>
<li>U5 M5M5165P static RAM: 0xC000 - 0xFFFF (8 KB aliased twice)</li>
<li>U6 M5M5165P static RAM: 0x8000 - 0xBFFF (8 KB aliased twice)</li>
</ul>
The 74HC138 is the decoder for the I/O ports:<br />
<ul>
<li>0x00 Z80 CTC (with CS0 connected to A0 and CS1 connected to A1)</li>
<ul>
<li>&nbsp;The CTC is connected as follows:</li>
<ul>
<li>TRG0 (pin 23) Not connected</li>
<li>TO0 (pin 7) Connected to TRG1</li>
<li>TRG1 (pin 22) Connected to TO0</li>
<li>TO1 (pin 8) Connected to clock pin of second flip-flop of the 74HC7, which drives speaker </li>
<li>TRG2 (pin 21) Not connected</li>
<li>TO2 (pin 9) Connected to TRG3</li>
<li>TRG3 (pin 20) Connected to TO2</li>
</ul>
</ul>
<li>0x20 Z80 PIO (with C/~D connected to A0 and B/~A connected to A1)</li>
<ul>
<li>&nbsp;The PIO is connected as follows:</li>
<ul>
<li>A0 (pin 15) Keypad row 0 (top row)</li>
<li>A1 (pin 14) Keypad row 1</li>
<li>A2 (pin 13) Keypad row 2</li>
<li>A3 (pin 12) Keypad row 3</li>
<li>A4 (pin 10) Transmit data to modem and DIN connector</li>
<li>A5 (pin 9) Carrier detect on 74HC942 modem</li>
<li>A6 (pin 8) To pin 6 of the MC1489.&nbsp; Pin 4 is connected to the DIN connector.&nbsp; My guess is that this is used for flow control.</li>
<li>A7 (pin 7) To pin 10 of the 74HC04.&nbsp; Pin 11 (the input) is connected to the tape head amplifier for reading the magnetic strip.</li>
<li>ARDY (pin 18) Not connected</li>
<li>~ASTB (pin 16) Not connected</li>
<li>B0 (pin 27) ~C1 of the touch-tone chip</li>
<li>B1 (pin 28) ~C2 of the touch-tone chip</li>
<li>B2 (pin 29) ~C3 of the touch-tone chip</li>
<li>B3 (pin 30) ~R1 of the touch-tone chip</li>
<li>B4 (pin 31) ~R2 of the touch-tone chip</li>
<li>B5 (pin 32) ~R3 of the touch-tone chip</li>
<li>B6 (pin 33) ~R4 of the touch-tone chip</li>
<li>B7 (pin 34) Receive data from modem and DIN connector</li>
<li>BRDY (pin 21) Not connected</li>
<li>~BSTB (pin 17) Not connected</li>
</ul>
</ul>
<li>0x40 U15 74HC259 (8-bit output port)</li>
<ul>
<li>D input is connected to A0</li>
<li>S0 is connected to A1</li>
<li>S1 is connected to A2</li>
<li>S2 is connected to A3</li>
<li>So it means write to an even location to clear a bit or write to the next higher odd location to set it </li>
<li>The 8 output bits are connected as follows:</li>
<ul>
<li>Q0 (pin 4, port 0x40) Keypad column 0 (left-most)</li>
<li>Q1 (pin 5, port 0x42) Keypad column 1</li>
<li>Q2 (pin 6, port 0x44) Keypad column 2</li>
<li>Q3 (pin 7, port 0x46) Keypad column 3</li>
<li>Q4 (pin 9, port 0x48) Goes to base of Q2.&nbsp; Emitter of Q2 goes to opto-isolator U20 (I think).&nbsp; This controls some part of the modem circuit.</li>
<li>Q5 (pin 10, port 0x4A) Clock signal for vacuum fluorescent display</li>
<li>Q6 (pin 11, port 0x4C) Data signal for vacuum fluorescent display</li>
<li>Q7 (pin 12, port 0x4E) Reset signal for vacuum fluorescent display.&nbsp; When this bit is low, reset is asserted.</li>
</ul>
</ul>
<li>0x60 U12 74HC259 (8-bit output port)</li>
<ul>
<li>The 8 output bits are connected as follows:</li>
<ul>
<li>Q0 (pin 4, port 0x60) to base of Q3.&nbsp; Emitter of Q3 goes to opto-isolator U28.&nbsp; This controls some part of the modem circuit.</li>
<li>Q1 (pin 5, port 0x62) to O/~A (Originate / Answer mode) pin of the 74HC942 modem</li>
<li>Q2 (pin 6, port 0x64) to "squelch transmitter" pin of 74HC942 modem</li>
<li>Q3 (pin 7, port 0x66) to base of Q1 which is connected to the "off hook" relay</li>
<li>Q4 (pin 9, port 0x68) to diode D3: I think something to do with the card reader</li>
<li>Q5 (pin 10, port 0x6A) to pin 10 (~preset2) of the 74HC74.&nbsp; I think used to enable or disable speaker.</li>
<li>Q6 (pin 11, port 0x6C) to address A pin of CD4052 MUX</li>
<li>Q7 (pin 12, port 0x6E) to address B pin of CD4052 MUX</li>
</ul>
</ul>
<li>0x80 M6242 (Real Time Clock)</li>
<li>0xA0 unused</li>
<li>0xC0 unused</li>
<li>0xE0 unused</li>
</ul>
<h2>
Sub-circuits</h2>
I should draw a schematic diagram for this thing, but it's so simple it's not really needed.&nbsp; Instead, here is a description of each of the sub-circuits I could find:<br />
<h3>
SIP connector</h3>
Here is a pin-out of the SIP header which connects the main board to the keypad/display board.&nbsp; Pin one is the one closest to the back of the machine:<br />
<ol>
<li>Keypad row 0 (top row)</li>
<li>Row 1</li>
<li>Row 2</li>
<li>Row 3</li>
<li>Keypad column 3 (right-most column)</li>
<li>Column 2</li>
<li>Column 1</li>
<li>Column 0</li>
<li>Not connected</li>
<li>Not connected</li>
<li>Not connected</li>
<li>Card reader / tape head</li>
<li>Display reset signal: active low</li>
<li>Display data signal</li>
<li>Display clock signal</li>
<li>+5V</li>
<li>Speaker</li>
<li>-5V</li>
<li>Speaker</li>
<li>GND </li>
</ol>
<h3>
Power Supply</h3>
It generates 5V and -5V with linear regulators.&nbsp; The -5V is used to power the negative rail of the OP-AMPs.&nbsp; The OP-AMP on the main board is used as a line driver for the data output pin of the DIN connector.&nbsp; The OP-AMP on the keypad/display board is the tape-head amplifier for the card reader.<br />
<br />
<h3>
Oscillator</h3>
One half of the 74HC74 is used to divide the 7.15909 MHz oscillator (made with the crystal and some 74HC04 inverters) in half to make 3.579545 MHz for the main CPU clock and the touch-tone generator IC.<br />
<br />
<h3>
Reset</h3>
It's provided by the L387A voltage regulator.&nbsp; It's connected to some chip select pins of the real time clock chip and the static RAM chips to help preserve their contents across reset.&nbsp; The static RAM chips and the real time clock chip are powered (through a diode-OR gate) by both line power and battery power.<br />
<br />
<h3>
Speaker</h3>
The piezo speaker is connected to the Q and ~Q outputs of second flip-flop in the 74HC74.&nbsp; The ~Q output is connected to the D input, so this flip-flop is wired up as a divide by two counter.&nbsp; The clock input is connected to the TO1 pin of the CTC: so you need to set up the CTC to generate the tone.&nbsp; The ~preset input is connected to the Q5 output of U12.&nbsp; I think the idea is to use this as an output enable bit so that you can leave the timer in the CTC always running.<br />
<br />
<h3>
Serial Port</h3>
A4 of the PIO is transmit data.&nbsp; B7 is receive data.&nbsp; I'm pretty sure that there was a schematic mistake with these assignments, since all of the other A pins are inputs and all of the other B pins are outputs.&nbsp; Anyway, the idea is that software needs to provide a "bit-banged" UART using these pins.<br />
<br />
These transmit and receive pins are connected to the CD4052 analog switch so that these same pins can be connected to different serial sources.&nbsp; The B and A address pins of the CD4052 are connected to U12 Q6 and Q7.<br />
<br />
<ul>
<li>B = 0, A = 0: serial lines connected to 74HC942 modem chip</li>
<li>B = 0, A = 1: serial lines connected to external DIN connector</li>
<li>B = 1, A = 0: serial lines connected to keypad/display board, but on this board they are wired to an unpopulated chip.&nbsp; I don't know the purpose.</li>
<li>B = 1, A = 1: input line connected to an MC1489 received which is fed from an OP-AMP.&nbsp; I don't know the purpose: maybe the OP-AMP is set up as a oscillator and this is some kind of test connection?&nbsp; The output line is connected to an opto-isolator U18, so this has something to do with the modem, but I'm not sure what.</li>
</ul>
<h3>
DIN connector</h3>
Here is the pin-out of the external connector:<br />
<br />
<div class="separator" style="clear: both; text-align: center;">
<a href="http://1.bp.blogspot.com/-lH-5N2R1FiE/UBwc3MWenBI/AAAAAAAAABM/Fakgl1z-rNs/s1600/din.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="https://1.bp.blogspot.com/-lH-5N2R1FiE/UBwc3MWenBI/AAAAAAAAABM/Fakgl1z-rNs/s1600/din.jpg" /></a></div>
<br />
<ol>
<li>GND</li>
<li>No Connect</li>
<li>No Connect</li>
<li>RS-232 level input to pin 4 of MC1489.&nbsp; Pin 6 of MC1489 goes to A6 of PIO.&nbsp; I think for flow control.</li>
<li>RS-232 level input to pin 1 of MC1489.&nbsp; Pin 3 of MC1489 goes to CD4052 MUX.&nbsp; This is the serial data input.</li>
<li>Connected to pin 7 of TL074.&nbsp; Pin 6 of TL074 is connected to CD4052 MUX.&nbsp; This is the serial data output.</li>
<li>No connect</li>
<li>Connected to 5V through a 47 ohm resistor.</li>
</ol>
The TL074 is being used as an RS-232 line driver. The output swings from 5V to -5V.<br />
<br />
<h3>
Keypad</h3>
U15 pins Q0 - Q3 drive the columns.&nbsp; A0 - A3 of the PIO are the row inputs.<br />
<br />
<h3>
Touch Tone Generator</h3>
B0 - B6 of the PIO are connected to the UM95089 touch tone generator chip.&nbsp; This chip is designed to be connected to a telephone keypad, so the software has to simulate a key-press by asserting one row bit and one column bit (by pulling the bits low, all of the others should remain high).<br />
<h3>
Display</h3>
To write to the display, you just send one entire line of 16 character to it.&nbsp; Each character is sent as a byte in the range 0x00 - 0x3F, and the byte is serialized so that the MSB is sent first.&nbsp; A falling clock edge should be provided for each bit.<br />
<br />
From the datasheet, a reset pulse of at least 100 us needs to be provided.&nbsp; After reset, you must wait another 100 us before writing any data.<br />
<br />
The clock has a maximum high time of 20 us, so it must be kept normally low.&nbsp; The minimum pulse width is 1 us.&nbsp; After each byte transferred, you must wait 120 us.<br />
<br />
The brightness of the display is controlled with the duty cycle command: 0xC0 - 0xFF, where 0xC0 is off and 0xFF is brightest.&nbsp; The default brightness after reset is off, so we must send one of these commands to turn the display on.<br />
<br />
The column to start writing to can be controlled with the commands 0xA0 - 0xAF.&nbsp; The left-most column is 0xAF, next one is 0xA0, etc.<br />
<br />
This is the character set from the data sheet:<br />
<br />
<div class="separator" style="clear: both; text-align: center;">
<a href="http://3.bp.blogspot.com/-DNk16Lq_Eek/UBwpnRbxBMI/AAAAAAAAABc/Rqtcv8m3uZw/s1600/font.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="264" src="https://3.bp.blogspot.com/-DNk16Lq_Eek/UBwpnRbxBMI/AAAAAAAAABc/Rqtcv8m3uZw/s640/font.jpg" width="640" /></a></div>
<br />
<h3>
"Hello, world!" program</h3>
We now have enough information to write our own programs for this hardware.<br />
<br />
We could certainly write them in Z-80 assembly language, but there is a nice free C compiler available: the Small Device C Compiler: <a href="http://sdcc.sourceforge.net/">SDCC</a>.<br />
<br />
Here is a program to write a message to the display:<br />
<br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><span style="font-size: xx-small;">/* IoPorts for vacuum fluorescent display */<br />/* Note SDCC special directive to declare and locate IO ports */<br /><br />__sfr __at 0x4a clr_clock;<br />__sfr __at 0x4b set_clock;<br /><br />__sfr __at 0x4c clr_data;<br />__sfr __at 0x4d set_data;<br /><br />__sfr __at 0x4e clr_reset;<br />__sfr __at 0x4f set_reset;<br /><br />/* 7.54 us delay */<br /><br />void delay()<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* Do nothing: the call / ret sequence is 7.54 us */<br />}<br /><br />/* At least 120 us */<br /><br />void long_delay()<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; unsigned char x;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (x = 0; x != 20; ++x)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delay();<br />}<br /><br />/* Serialize one byte and send it to display */<br /><br />void send_byte(unsigned char c)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; unsigned char scan = 0x80;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ((c &amp; scan) != 0) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set_data = 1;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clr_data = 1;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set_clock = 1;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delay();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clr_clock = 1;&nbsp; /* Falling edge when data is stable */<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delay();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; scan &gt;&gt;= 1;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } while(scan != 0);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; long_delay(); /* 120 us delay after each character sent */<br />}<br /><br />/* Write entire line */<br /><br />void send_msg(char *s)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; char x;</span></span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><span style="font-size: xx-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; send_byte(0xAF); /* Point to first digit */</span></span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><span style="font-size: xx-small;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; for (x = 0; x != 16; ++x) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (*s != 0) {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; send_byte(0x3F &amp; *s++);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; send_byte(0x20); /* Spaces to end of line */<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; send_byte(0xFF); /* Enable display, full brightness */<br />}<br /><br />/* Initialize display */<br /><br />void init_display()<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clr_clock = 1; /* Clock is normally low */<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; clr_reset = 1; /* Assert reset */<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; long_delay();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set_reset = 1; /* Release reset */<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; long_delay();</span></span><br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><span style="font-size: xx-small;">}<br /><br />int main()<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; init_display();<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; send_msg("HELLO, WORLD!");<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return 0;<br />}</span></span><br />
<br />
To compile, we use the following command:<br />
<br />
<span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;">sdcc -mz80 --xram-loc 0x8000 test.c</span><br />
<br />
The '-mz80' sets the architecture to Z-80.&nbsp; The '--xram-loc' sets the location of the RAM: the data section will be placed there.<br />
<br />
The compiler will link with an included simple C startup program, "crt0.s" and generate an Intel Hex Format file which can be used in the EPROM programmer.&nbsp; Crt0.s sets the stack to 0xFFFF and provides a jump instruction from the reset vector to the code.&nbsp; It places "reti" instructions in the interrupt vectors.<br />
<br />
If you have initialized global variables, they will be located in the data section (in RAM), and code will be generated to set their initial value.&nbsp; This code is located along with the rest of the code in EPROM.<br />
<br />
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody>
<tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-zfGJKXHAUrw/UB1QHVuO0GI/AAAAAAAAACU/AwfNNxCKQIE/s1600/eprom.jpg" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="311" src="https://2.bp.blogspot.com/-zfGJKXHAUrw/UB1QHVuO0GI/AAAAAAAAACU/AwfNNxCKQIE/s320/eprom.jpg" width="320" /></a></td></tr>
<tr><td class="tr-caption" style="text-align: center;">Old UV EPROM eraser and old MS-DOS based EPROM programmer</td></tr>
</tbody></table>
And here is the result:<br />
<br />
<div class="separator" style="clear: both; text-align: center;">
</div>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody>
<tr><td style="text-align: center;"><a href="http://3.bp.blogspot.com/-8Fc6Vr24Vpc/UB1UVxRJACI/AAAAAAAAACk/zrf9dSVuqyE/s1600/hacked.jpg" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" height="308" src="https://3.bp.blogspot.com/-8Fc6Vr24Vpc/UB1UVxRJACI/AAAAAAAAACk/zrf9dSVuqyE/s320/hacked.jpg" width="320" /></a></td></tr>
<tr><td class="tr-caption" style="text-align: center;">(click to enlarge)</td></tr>
</tbody></table>
<br />
The '@'&nbsp; at the end of the line is due to the fact that the ',' is not really a character: instead it turns out to be a modifier of the previous character.&nbsp; You can see that the ',' is not using an entire character position.&nbsp; So we intended to send 16 character, but really only sent 15, which left the last character left at its reset value.&nbsp; Anyway, my send_msg function needs to account for this.&nbsp; The '!' looks funny, but it's due to the font.<br />
<br />
<br />
